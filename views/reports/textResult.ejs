<% layout('layouts/boilerplate') %>

<div class="container mt-5">
  <h3 class="mb-4">Your AI Medical Report Summary</h3>

  <!-- Summary box -->
  <div class="border p-3 bg-light rounded mb-4" id="summaryText">
    <%= report.summaryText %>
  </div>

  <!-- Action buttons row -->
  <div class="row g-2 align-items-center">
    <!-- Upload Another -->
    <div class="col-md-3 d-grid">
      <a href="/ai-report" class="btn btn-primary btn-lg">Upload Another</a>
    </div>

    <!-- TTS -->
    <div class="col-md-3 d-grid">
      <button id="ttsBtn" class="btn btn-success btn-lg">Listen to Summary</button>
    </div>

    <!-- Video -->
    <div class="col-md-3 d-grid">
      <a href="/ai-report/video-result/<%= report._id %>" class="btn btn-warning btn-lg">Watch Video</a>
    </div>

    <!-- Translate -->
    <div class="col-md-3 d-flex">
      <select id="languageSelect" class="form-select me-2">
        <option value="es">Spanish</option>
        <option value="fr">French</option>
        <option value="de">German</option>
        <option value="hi">Hindi</option>
        <option value="zh">Chinese</option>
        <option value="ar">Arabic</option>
      </select>
      <button id="translateBtn" class="btn btn-info flex-shrink-0">Translate</button>
    </div>
  </div>

  <!-- TTS audio player -->
  <div id="ttsPlayerContainer" class="mt-3" style="display:none;">
    <audio id="ttsPlayer" controls class="w-100"></audio>
  </div>
</div>

<script>
  const reportId = "<%= report._id %>";

  // TEXT-TO-SPEECH
  document.getElementById("ttsBtn").addEventListener("click", async () => {
    const res = await fetch(`/ai-report/tts/${reportId}`);
    if (res.ok) {
      const audioUrl = await res.text(); // server returns audio URL
      const player = document.getElementById("ttsPlayer");
      player.src = audioUrl;
      document.getElementById("ttsPlayerContainer").style.display = "block";
      player.play();
    } else {
      alert("Error generating speech");
    }
  });

  // TRANSLATE
  document.getElementById("translateBtn").addEventListener("click", async () => {
    const lang = document.getElementById("languageSelect").value;
    const res = await fetch(`/ai-report/translate/${reportId}?lang=${lang}`);
    if (res.ok) {
      const data = await res.json();
      document.getElementById("summaryText").innerText = data.translatedText;
    } else {
      alert("Error translating summary");
    }
  });
</script>
